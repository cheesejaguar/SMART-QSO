# SMART-QSO Flight Software CI Pipeline
#
# Continuous Integration workflow for flight software validation
# Following NASA NPR 7150.2 software engineering requirements
#
# Runs on every push and pull request to verify:
# - Build success with warnings as errors
# - Static analysis (cppcheck)
# - Unit test execution
# - Code coverage reporting

name: Flight Software CI

on:
  push:
    branches: [ main, develop, 'feature/**', 'release/**' ]
    paths:
      - 'software/flight/**'
      - '.github/workflows/flight-software-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'software/flight/**'

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build and Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential cppcheck libcmocka-dev

    - name: Configure CMake
      working-directory: software/flight
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DENABLE_WERROR=ON

    - name: Build
      working-directory: software/flight
      run: cmake --build build --config ${{ env.BUILD_TYPE }}

    - name: Run cppcheck static analysis
      working-directory: software/flight
      run: |
        cppcheck --enable=all --inconclusive --std=c11 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=knownConditionTrueFalse \
          --suppress=nullPointerRedundantCheck \
          --suppress=unusedStructMember \
          --suppress=constParameterPointer \
          --suppress=constParameterCallback \
          --suppress=constVariablePointer \
          --suppress=variableScope \
          --error-exitcode=1 \
          -I include \
          src/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flight-software-build
        path: software/flight/build/smart_qso_flight

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libcmocka-dev lcov

    - name: Configure CMake with coverage
      working-directory: software/flight
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON

    - name: Build
      working-directory: software/flight
      run: cmake --build build

    - name: Run tests
      working-directory: software/flight/build
      run: ctest --output-on-failure

    - name: Generate coverage report
      working-directory: software/flight
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --ignore-errors unused --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: software/flight/coverage.info

  sanitizers:
    name: Sanitizer Checks
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libcmocka-dev

    - name: Configure CMake with sanitizers
      working-directory: software/flight
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_SANITIZERS=ON

    - name: Build
      working-directory: software/flight
      run: cmake --build build

    - name: Run with sanitizers
      working-directory: software/flight/build
      run: |
        # Run the executable briefly to check for sanitizer issues
        timeout 5 ./smart_qso_flight || true

  flight-build:
    name: Flight Configuration Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Configure CMake for flight
      working-directory: software/flight
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DFLIGHT_BUILD=ON -DENABLE_WERROR=ON

    - name: Build flight configuration
      working-directory: software/flight
      run: cmake --build build

    - name: Verify NDEBUG is defined
      working-directory: software/flight
      run: |
        # Check that debug code is disabled in flight build
        grep -q "NDEBUG" build/compile_commands.json || echo "NDEBUG check"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check required documentation exists
      run: |
        # Verify critical documentation files exist
        test -f software/flight/docs/FDIR_DESIGN.md
        test -f software/flight/docs/MEMORY_POLICY.md
        test -f software/flight/docs/LOOP_BOUNDS.md
        test -f software/flight/docs/MISRA_DEVIATIONS.md
        test -f software/flight/docs/JPL_POWER_OF_TEN_AUDIT.md
        test -f docs/safety/SOFTWARE_HAZARD_ANALYSIS.md
        test -f docs/safety/SOFTWARE_FMEA.md
        echo "All required documentation present"

    - name: Check for TODO/FIXME in production code
      working-directory: software/flight
      run: |
        # Warn about TODOs but don't fail
        grep -rn "TODO\|FIXME" src/ include/ || echo "No TODOs found"
