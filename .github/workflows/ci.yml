###############################################################################
# SMART-QSO Flight Software CI/CD Pipeline
#
# Compliant with NASA NPR 7150.2 software engineering requirements
# Following NASA Ames Small Satellite Division heritage
###############################################################################

name: Flight Software CI

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
    paths:
      - 'software/flight/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'software/flight/**'
      - '.github/workflows/ci.yml'

env:
  BUILD_TYPE: Release

jobs:
  ###########################################################################
  # Build and Unit Test Job
  ###########################################################################
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libcmocka-dev \
            cppcheck \
            clang-tidy \
            lcov \
            valgrind

      - name: Configure CMake
        working-directory: software/flight
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DENABLE_COVERAGE=ON \
            -DENABLE_WERROR=ON

      - name: Build
        working-directory: software/flight
        run: cmake --build build --parallel $(nproc)

      - name: Run unit tests
        working-directory: software/flight
        run: ctest --test-dir build --output-on-failure --parallel $(nproc)

      - name: Generate coverage report
        working-directory: software/flight
        run: |
          lcov --capture --directory build --output-file coverage.info
          lcov --ignore-errors unused --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: software/flight/coverage.info
          flags: flight-software
          name: flight-coverage
          fail_ci_if_error: false

  ###########################################################################
  # Static Analysis Job
  ###########################################################################
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake cppcheck clang-tidy

      - name: Configure CMake (for compile_commands.json)
        working-directory: software/flight
        run: cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run cppcheck
        working-directory: software/flight
        run: |
          cppcheck \
            --enable=all \
            --inconclusive \
            --std=c11 \
            --inline-suppr \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=knownConditionTrueFalse \
            --suppress=nullPointerRedundantCheck \
            --suppress=unusedStructMember \
            --suppress=constParameterPointer \
            --suppress=constParameterCallback \
            --suppress=constVariablePointer \
            --suppress=variableScope \
            --error-exitcode=1 \
            -I include \
            src/

      - name: Run clang-tidy
        working-directory: software/flight
        run: |
          clang-tidy \
            -p build \
            src/*.c \
            --warnings-as-errors='*' \
            || true  # Allow warnings for now during development

  ###########################################################################
  # MISRA Compliance Check Job (placeholder)
  ###########################################################################
  misra-check:
    name: MISRA C:2012 Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: MISRA compliance note
        run: |
          echo "MISRA C:2012 compliance checking requires commercial tools"
          echo "Deviations documented in docs/software/MISRA_DEVIATIONS.md"

  ###########################################################################
  # Security Scan Job
  ###########################################################################
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: c-cpp

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake

      - name: Build for analysis
        working-directory: software/flight
        run: |
          cmake -B build
          cmake --build build

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  ###########################################################################
  # Documentation Generation Job
  ###########################################################################
  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install -y doxygen graphviz

      - name: Generate documentation
        working-directory: software/flight
        run: |
          if [ -f Doxyfile ]; then
            doxygen Doxyfile
          else
            echo "Doxyfile not found - skipping documentation generation"
          fi

  ###########################################################################
  # Flight Build Validation Job
  ###########################################################################
  flight-build:
    name: Flight Build Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake

      - name: Configure Flight Build
        working-directory: software/flight
        run: |
          cmake -B build \
            -DFLIGHT_BUILD=ON \
            -DENABLE_WERROR=ON

      - name: Build Flight Configuration
        working-directory: software/flight
        run: cmake --build build --parallel $(nproc)

      - name: Verify no debug symbols
        working-directory: software/flight
        run: |
          if nm build/smart_qso_flight | grep -q "printf"; then
            echo "Note: printf symbols present (expected in simulation stub)"
          fi
